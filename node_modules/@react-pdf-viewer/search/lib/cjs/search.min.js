"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=n(e),a=function(){return r.default.createElement(t.Icon,{size:16},r.default.createElement("path",{d:"M0.541,5.627L11.666,18.2c0.183,0.207,0.499,0.226,0.706,0.043c0.015-0.014,0.03-0.028,0.043-0.043\n                L23.541,5.627"}))},o=function(){return r.default.createElement(t.Icon,{size:16},r.default.createElement("path",{d:"M23.535,18.373L12.409,5.8c-0.183-0.207-0.499-0.226-0.706-0.043C11.688,5.77,11.674,5.785,11.66,5.8\n                L0.535,18.373"}))},c=function(){return r.default.createElement(t.Icon,{size:16},r.default.createElement("path",{d:"M10.5,0.5c5.523,0,10,4.477,10,10s-4.477,10-10,10s-10-4.477-10-10S4.977,0.5,10.5,0.5z\n                M23.5,23.5\n                l-5.929-5.929"}))},u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},l=new RegExp(" "),s=function(t){var n=e.useState(t.get("doc")),r=n[0],a=n[1],o=function(e){a(e)};return e.useEffect((function(){return t.subscribe("doc",o),function(){t.unsubscribe("doc",o)}}),[]),{currentDoc:r}},i=function(t,n){var r=e.useState(""),a=r[0],o=r[1],c=e.useState([]),u=c[0],s=c[1],i=e.useState(0),f=i[0],d=i[1],h=e.useState(!1),p=h[0],m=h[1],v=e.useRef([]),g=e.useState(!1),E=g[0],x=g[1],y=Array(t.numPages).fill(0).map((function(e,t){return t})),C=function(e){var t=n.get("jumpToPage");t&&t(e.pageIndex),n.update("match",e)},b=function(e,r,a){var o,c=function(e,t,n){return new RegExp(n?" "+e+" ":e,t?"g":"gi")}(e,r,a);n.update("keyword",[c]),d(0),s([]),(0===v.current.length?(o=y.map((function(e){return t.getPage(e+1).then((function(e){return e.getTextContent()})).then((function(t){var n=t.items.map((function(e){return e.str||""})).join("");return Promise.resolve({pageContent:n,pageIndex:e})}))})),Promise.all(o).then((function(e){return e.sort((function(e,t){return e.pageIndex-t.pageIndex})),Promise.resolve(e.map((function(e){return e.pageContent})))}))).then((function(e){return v.current=e,Promise.resolve(e)})):Promise.resolve(v.current)).then((function(e){var t=[];e.forEach((function(e,n){for(var r=(e.match(c)||[]).length,a=0;a<r;a++)t.push({matchIndex:a,pageIndex:n})})),s(t),t.length>0&&(d(1),C(t[0]))}))};return{clearKeyword:function(){a&&(n.update("keyword",[l]),o(""),d(0),s([]),m(!1),x(!1))},changeMatchCase:function(e){m(e),a&&b(a,e,E)},changeWholeWords:function(e){x(e),a&&b(a,p,e)},currentMatch:f,jumpToNextMatch:function(){if(a){var e=f+1,t=e<=u.length?e:1;d(t),C(u[t-1])}},jumpToPreviousMatch:function(){if(a){var e=f-1,t=e>0?e:u.length;d(t),C(u[t-1])}},keyword:a,matchCase:p,numberOfMatches:u.length,wholeWords:E,search:function(){return b(a,p,E)},setKeyword:o}},f=function(e){var t=e.children,n=e.doc,r=e.store,a=i(n,r);return t(u({},a))},d=function(e){var t=e.children,n=e.store,a=s(n).currentDoc;return a?r.default.createElement(f,{doc:a,store:n},t):r.default.createElement(r.default.Fragment,null)},h={left:0,top:8},p=function(n){var c=n.doc,u=n.store,l=n.onToggle,s=e.useContext(t.LocalizationContext),f=i(c,u),d=f.clearKeyword,p=f.changeMatchCase,m=f.changeWholeWords,v=f.currentMatch,g=f.jumpToNextMatch,E=f.jumpToPreviousMatch,x=f.keyword,y=f.matchCase,C=f.numberOfMatches,b=f.wholeWords,S=f.search,w=f.setKeyword;return r.default.createElement("div",{className:"rpv-search-popover"},r.default.createElement("div",{className:"rpv-search-popover-input-counter"},r.default.createElement("input",{className:"rpv-search-popover-input",placeholder:s&&s.search?s.search.enterToSearch:"Enter to search",type:"text",value:x,onChange:function(e){w(e.target.value)},onKeyDown:function(e){13===e.keyCode&&x&&S()}}),r.default.createElement("div",{className:"rpv-search-popover-counter"},v,"/",C)),r.default.createElement("label",{className:"rpv-search-popover-label"},r.default.createElement("input",{className:"rpv-search-popover-label-checkbox",checked:y,type:"checkbox",onChange:function(e){p(e.target.checked)}})," ",s&&s.search?s.search.matchCase:"Match case"),r.default.createElement("label",{className:"rpv-search-popover-label"},r.default.createElement("input",{className:"rpv-search-popover-label-checkbox",checked:b,type:"checkbox",onChange:function(e){m(e.target.checked)}})," ",s&&s.search?s.search.wholeWords:"Whole words"),r.default.createElement("div",{className:"rpv-search-popover-footer"},r.default.createElement("div",{className:"rpv-search-popover-footer-item"},r.default.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:r.default.createElement(t.Button,{onClick:E},r.default.createElement(o,null)),content:function(){return s&&s.search?s.search.previousMatch:"Previous match"},offset:h})),r.default.createElement("div",{className:"rpv-search-popover-footer-item"},r.default.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:r.default.createElement(t.Button,{onClick:g},r.default.createElement(a,null)),content:function(){return s&&s.search?s.search.nextMatch:"Next match"},offset:h})),r.default.createElement("div",{className:"rpv-search-popover-footer-button"},r.default.createElement(t.PrimaryButton,{onClick:function(){l(),d()}},s&&s.search?s.search.close:"Close"))))},m=function(n){var a=n.children,o=n.onClick,u=e.useContext(t.LocalizationContext),l=u&&u.search?u.search.search:"Search";return a({icon:r.default.createElement(c,null),label:l,onClick:o})},v={left:0,top:8},g=function(e){var n=e.onClick;return r.default.createElement(m,{onClick:n},(function(e){return r.default.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:r.default.createElement(t.Button,{onClick:n},e.icon),content:function(){return e.label},offset:v})}))},E={left:0,top:8},x=function(e){var n=e.children,a=e.store,o=s(a).currentDoc,c=n||function(e){return r.default.createElement(g,u({},e))};return o?r.default.createElement(t.Popover,{position:t.Position.BottomLeft,target:function(e){return c({onClick:e})},content:function(e){return r.default.createElement(p,{doc:o,store:a,onToggle:e})},offset:E,closeOnClickOutside:!1,closeOnEscape:!0}):r.default.createElement(r.default.Fragment,null)},y=function(e){var t=e.parentNode;t&&t.removeChild(e)},C=function(e){var t=e.parentNode;if(t){var n=document.createRange();n.selectNodeContents(e),function(e,t){y(e);var n=t.parentNode;n&&n.insertBefore(e,t),y(t)}(n.extractContents(),e),t.normalize()}},b=function(n){var a=n.pageIndex,o=n.store,c=e.useState({matchIndex:-1,pageIndex:-1}),u=c[0],s=c[1],i=e.useState([l]),f=i[0],d=i[1],h=e.useState({pageIndex:a,scale:1,status:t.LayerRenderStatus.PreRender}),p=h[0],m=h[1],v=e.useRef(null),g=function(e){for(var t=e.querySelectorAll("span.rpv-search-text-highlight"),n=t.length,r=0;r<n;r++)t[r].parentElement.removeChild(t[r])},E=function(e){var t=[].slice.call(e.querySelectorAll(".rpv-core-text"));f.forEach((function(n){t.forEach((function(t){!function(e,t,n){var r=n.textContent;if(e.source.trim()&&r){var a=r.search(e),o=n.firstChild;if(-1!==a&&o){var c=a+e.source.length,u=document.createRange();u.setStart(o,a),u.setEnd(o,c);var l=document.createElement("span");u.surroundContents(l);var s=l.getBoundingClientRect(),i=t.getBoundingClientRect(),f=document.createElement("span");t.appendChild(f),f.style.left=100*(s.left-i.left)/i.width+"%",f.style.top=100*(s.top-i.top)/i.height+"%",f.style.width=100*s.width/i.width+"%",f.style.height=100*s.height/i.height+"%",f.classList.add("rpv-search-text-highlight"),C(l)}}}(n,e,t)}))}))},x=function(e){e&&e.length>0&&d(e)},y=function(e){s(e)},b=function(e){if(e.has(a)){var t=e.get(a);t&&m({ele:t.ele,pageIndex:a,scale:t.scale,status:t.status})}},S=function(){return 0===f.length||1===f.length&&""===f[0].source.trim()};e.useEffect((function(){if(!S()&&p.ele&&p.status===t.LayerRenderStatus.DidRender){var e=p.ele;g(e),E(e),w()}}),[f,u,p.status]),e.useEffect((function(){S()&&p.ele&&p.status===t.LayerRenderStatus.DidRender&&g(p.ele)}),[f,p.status]);var w=function(){if(u.pageIndex===a&&p.ele&&p.status===t.LayerRenderStatus.DidRender){var e=p.ele,n=e.querySelectorAll(".rpv-search-text-highlight");if(u.matchIndex<n.length){var r=n[u.matchIndex],c=function(e,t){for(var n=e.offsetTop,r=e.offsetLeft,a=e.parentElement;a&&a!==t;)n+=a.offsetTop,r+=a.offsetLeft,a=a.parentElement;return{left:r,top:n}}(r,e),l=c.left,s=c.top,i=o.get("jumpToDestination");i&&(i(a,(e.getBoundingClientRect().height-s)/p.scale,l/p.scale,p.scale),v.current&&v.current.classList.remove("rpv-search-text-highlight-current"),v.current=r,r.classList.add("rpv-search-text-highlight-current"))}}};return e.useEffect((function(){return o.subscribe("keyword",x),o.subscribe("match",y),o.subscribe("renderStatus",b),function(){o.unsubscribe("keyword",x),o.unsubscribe("match",y),o.unsubscribe("renderStatus",b)}}),[]),r.default.createElement(r.default.Fragment,null)};exports.NextIcon=a,exports.PreviousIcon=o,exports.SearchIcon=c,exports.searchPlugin=function(e){var n=t.createStore({renderStatus:new Map}),a=function(e){return r.default.createElement(x,u({},e,{store:n}))},o=function(e){return"string"==typeof e?""===e?l:new RegExp(e):e||l};return{install:function(t){var r=[l];e&&(r=Array.isArray(e.keyword)?e.keyword.map((function(e){return o(e)})):[o(e.keyword)]),n.update("jumpToDestination",t.jumpToDestination),n.update("jumpToPage",t.jumpToPage),n.update("keyword",r)},renderViewer:function(e){var t=e.slot;return t.subSlot&&(t.subSlot.children=r.default.createElement(r.default.Fragment,null,Array(e.doc.numPages).fill(0).map((function(e,t){return r.default.createElement(b,{key:t,pageIndex:t,store:n})})),t.subSlot.children)),t},uninstall:function(e){var t=n.get("renderStatus");t&&t.clear()},onDocumentLoad:function(e){n.update("doc",e.doc)},onTextLayerRender:function(e){var t=n.get("renderStatus");t&&(t=t.set(e.pageIndex,e),n.update("renderStatus",t))},Search:function(e){return r.default.createElement(d,u({},e,{store:n}))},ShowSearchPopover:a,ShowSearchPopoverButton:function(){return r.default.createElement(a,null,(function(e){return r.default.createElement(g,u({},e))}))}}};
